#+TITLE: Emacs Config
#+AUTHOR: Yun-L
#+LANGUAGE: en

* Setup
** straight.el
- package management bootstrap code (must be before other packages)
- requires git
- https://github.com/raxod502/straight.el
#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 5))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
#+end_src

** use-package
- must be installed right after straight.el
- config management
#+begin_src emacs-lisp
  (straight-use-package 'use-package)
#+end_src
- enable package statistics (must be enabled right after use-package installation)
- run cmd M-x use-package-report to see results
#+begin_src emacs-lisp
  (setq use-package-compute-statistics t)
#+end_src

* Preferences
** better defaults
#+begin_src emacs-lisp
  (global-visual-line-mode 1)
  (fringe-mode '(2 . 0))
  (setq-default tab-width 4)
  (defalias 'yes-or-no-p 'y-or-n-p)
  (tool-bar-mode 0)
  (scroll-bar-mode 0)
  (tooltip-mode 0)
  (menu-bar-mode 0)
  (setq inhibit-startup-screen t)
  (setq ring-bell-function 'ignore)
#+end_src

- quick access to configs
#+begin_src emacs-lisp
  (defun find-user-config-file ()
    (interactive)
    (if (file-exists-p "~/.emacs.d/config.org")
        (find-file "~/.emacs.d/config.org")
      (error "%s" "no config.org file found in ~/.emacs.d/")))

  (global-set-key (kbd "C-~") 'find-user-config-file)
#+end_src

** file backups/autosave
- creates the following directories and saves backups/autosaves to them:
  - .emacs.d/backup/
  - .emacs.d/autosave/
#+begin_src emacs-lisp
  (if (file-directory-p "~/.emacs.d/backup/")
      nil
    (make-directory "~/.emacs.d/backup/"))
  (if (file-directory-p "~/.emacs.d/autosave/")
      nil
    (make-directory "~/.emacs.d/autosave/"))
  (defvar backup-dir (expand-file-name "~/.emacs.d/backup/"))
  (defvar autosave-dir (expand-file-name "~/.emacs.d/autosave/"))
  (setq backup-directory-alist (list (cons ".*" backup-dir)))
  (setq auto-save-list-file-prefix autosave-dir)
  (setq auto-save-file-name-transforms `((".*" ,autosave-dir t)))
#+end_src

* Interface
** undo-tree
- represent edit history as a tree
- https://www.emacswiki.org/emacs/UndoTree
- docs: https://www.dr-qubit.org/undo-tree/undo-tree.txt
#+begin_src emacs-lisp
  (use-package undo-tree
    :straight t
    :config
    (global-undo-tree-mode))
#+end_src

** which-key
- dispay keybindings after some time
- https://github.com/justbur/emacs-which-key
#+begin_src emacs-lisp
  (use-package which-key
    :straight t
    :config
    (which-key-mode))
#+end_src

** transpose-frame
- transpose window arrangement
- https://github.com/emacsmirror/emacswiki.org/blob/master/transpose-frame.el
#+begin_src emacs-lisp
  (use-package transpose-frame
    :straight t)
#+end_src

** ace-window
- better window switching
- https://github.com/abo-abo/ace-window
#+begin_src emacs-lisp
  (use-package ace-window
    :straight t
    :bind ("M-o" . ace-window)
    :custom
    (aw-dispatch-always 1))
#+end_src

** sr-speedbar
- speedbar in the same frame
- https://www.emacswiki.org/emacs/SrSpeedbar
- https://www.gnu.org/software/emacs/manual/html_node/speedbar/
#+begin_src emacs-lisp
  (use-package sr-speedbar
    :straight t
    :bind ([f8] . sr-speedbar-toggle)
    :custom
    (speedbar-use-images nil "disable icons")
    (speedbar-directory-unshown-regexp "^\\(CVS\\|RCS\\|SCCS\\|\\.\\.*$\\)\\'"))
#+end_src

** god-mode
- enter commands without modifier keys
- https://github.com/emacsorphanage/god-mode
#+begin_src emacs-lisp
  (use-package god-mode
    :straight t
    :config
    (global-set-key (kbd "<escape>") #'god-local-mode)
    (defun my-god-mode-update-cursor ()
      (setq cursor-type (if (or god-local-mode buffer-read-only)
                            'box
                          'bar)))

    (add-hook 'god-mode-enabled-hook #'my-god-mode-update-cursor)
    (add-hook 'god-mode-disabled-hook #'my-god-mode-update-cursor))
#+end_src

** treemacs
- tree layout file explorer
- https://github.com/Alexander-Miller/treemacs
#+begin_src emacs-lisp
  (use-package treemacs
    :straight t
    :config
    (treemacs-follow-mode t)
    (treemacs-filewatch-mode t)
    (pcase (cons (not (null (executable-find "git")))
                 (not (null treemacs-python-executable)))
      (`(t . t)
       (treemacs-git-mode 'deferred))
      (`(t . _)
       (treemacs-git-mode 'simple)))
    :bind
    (:map global-map
          ("M-0"       . treemacs-select-window)
          ("C-x t t"   . treemacs)
          ("C-x t B"   . treemacs-bookmark)
          ("C-x t C-t" . treemacs-find-file)
          ("C-x t M-t" . treemacs-find-tag)))
#+end_src

** projectile
- project management
- https://github.com/bbatsov/projectile
#+begin_src emacs-lisp
  (use-package projectile
    :straight t
    :config
    (projectile-mode +1)
    (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)
    :custom
    (projectile-completion-system 'ivy "use ivy for projectile completion backend"))
#+end_src

** treemacs-projectile
- projectile integration with treemacs
- https://github.com/bbatsov/projectile
#+begin_src emacs-lisp
  (use-package treemacs-projectile
    :straight t
    :after (treemacs projectile))
#+end_src

** workgroups
- workspace management
#+begin_src emacs-lisp
  (use-package workgroups
    :disabled
    :straight t
    :config
    (workgroups-mode t)
    :custom
    (wg-prefix-key (kbd "C-c w")))
#+end_src

** persp-mode
- workspace management (shared among frames)
- manually start functionality with persp-mode
- https://github.com/Bad-ptr/persp-mode.el
#+begin_src emacs-lisp
  (use-package persp-mode
    :straight t
    :config
    (add-hook 'window-setup-hook #'(lambda () (persp-mode 1)))
    :custom
    (persp-keymap-prefix (kbd "C-c w"))
    (persp-autokill-buffer-on-remove 'kill-weak)

    (defvar after-switch-to-buffer-functions nil)
    (defvar after-display-buffer-functions nil)

    (if (fboundp 'advice-add)
        ;;Modern way
        (progn
          (defun after-switch-to-buffer-adv (&rest r)
            (apply #'run-hook-with-args 'after-switch-to-buffer-functions r))
          (defun after-display-buffer-adv (&rest r)
            (apply #'run-hook-with-args 'after-display-buffer-functions r))
          (advice-add #'switch-to-buffer :after #'after-switch-to-buffer-adv)
          (advice-add #'display-buffer   :after #'after-display-buffer-adv)))

    (with-eval-after-load "persp-mode"
      (global-set-key (kbd "C-x b") #'persp-switch-to-buffer)
      (global-set-key (kbd "C-x k") #'persp-kill-buffer))
  
    (with-eval-after-load "persp-mode"
      (with-eval-after-load "ivy"
        (add-hook 'ivy-ignore-buffers
                  #'(lambda (b)
                      (when persp-mode
                        (let ((persp (get-current-persp)))
                          (if persp
                              (not (persp-contain-buffer-p b persp))
                            nil)))))

        (setq ivy-sort-functions-alist
              (append ivy-sort-functions-alist
                      '((persp-kill-buffer   . nil)
                        (persp-remove-buffer . nil)
                        (persp-add-buffer    . nil)
                        (persp-switch        . nil)
                        (persp-window-switch . nil)
                        (persp-frame-switch  . nil)))))))
#+end_src

** persp-mode-projectile-bridge
- projectile integration with persp-mode
- https://github.com/Bad-ptr/persp-mode-projectile-bridge.el
#+begin_src emacs-lisp
  (use-package persp-mode-projectile-bridge
    :straight t
    :after (persp-mode projectile)
    :config
    (with-eval-after-load "persp-mode-projectile-bridge-autoloads"
      (add-hook 'persp-mode-projectile-bridge-mode-hook
                #'(lambda ()
                    (if persp-mode-projectile-bridge-mode
                        (persp-mode-projectile-bridge-find-perspectives-for-all-buffers)
                      (persp-mode-projectile-bridge-kill-perspectives))))
      (add-hook 'after-init-hook
                #'(lambda ()
                    (persp-mode-projectile-bridge-mode 1))
                t)))
#+end_src

** prescient
- sort and filter lists of candidates (for ivy/company listing)
- https://github.com/raxod502/prescient.el
#+begin_src emacs-lisp
  (use-package prescient
    :straight t)
#+end_src

** ivy-prescient
- prescient integration with ivy
- https://github.com/raxod502/prescient.el
#+begin_src emacs-lisp
  (use-package ivy-prescient
    :straight t
    :after (prescient ivy counsel)
    :config
    (ivy-prescient-mode))
#+end_src
** ivy
- completion framework
- replaces built in ido functionality
- https://github.com/abo-abo/swiper
#+begin_src emacs-lisp
  (use-package ivy
    :straight t
    :config
    (ivy-mode t)
    :custom
    (ivy-use-virtual-buffers t)
    (enable-recursive-minibuffers t)
    (ivy-count-format "[%d/%d] "))
#+end_src

** counsel
- provides versions of common emacs commands that use ivy
- https://github.com/abo-abo/swiper
#+begin_src emacs-lisp
  (use-package counsel
    :straight t
    :after (ivy))
#+end_src

** swiper
- ivy enhance version of isearch
- https://github.com/abo-abo/swiper
#+begin_src emacs-lisp
  (use-package swiper
    :straight t
    :after (ivy)
    :bind (("C-s" . swiper-isearch)))
#+end_src

** avy
- jumping to visible text w/ char-based decision tree
- https://github.com/abo-abo/avy
#+begin_src emacs-lisp
  (use-package avy
    :straight t
    :bind
    (("C-:" . avy-goto-char)
     ("C-;" . avy-goto-char-2))
    :custom
    (avy-keys '(?a ?o ?e ?u ?i ?d ?h ?t ?n ?s) "change to dvorak home row keys"))
#+end_src

* Appearance
** powerline
- better status bar
#+begin_src emacs-lisp
  (use-package powerline
    :straight t)
#+end_src

** moe-theme
- color theme
#+begin_src emacs-lisp
  (use-package moe-theme
    :straight t
    :after (powerline)
    :init
     (setq moe-theme-mode-line-color 'magenta)
    :config
    (moe-dark)
    (powerline-moe-theme)
    :bind
    (("C-c t d" . (lambda ()
                    "switch to moe-dark theme"
                    (interactive)
                    (moe-dark)))
     ("C-c t l" . (lambda ()
                    "switch to moe-light theme"
                    (interactive)
                    (moe-light)))))
#+end_src

* Programming
** YASnippet
- template system
- https://github.com/joaotavora/yasnippet
#+begin_src emacs-lisp
  (use-package yasnippet
    :straight t
    :config
    (yas-global-mode 1))
#+end_src

** magit 
- git interface
- https://magit.vc/
#+begin_src emacs-lisp
  (use-package magit
    :straight t
    :bind ("C-x g" . magit-status))
#+end_src

** flycheck
- syntax checking
- https://www.flycheck.org/en/latest/index.html
#+begin_src emacs-lisp
  (use-package flycheck
    :straight t)
#+end_src

** company
- inbuffer auto complete
#+begin_src emacs-lisp
  (use-package company
    :straight t
    :init
    (global-company-mode))
#+end_src

** company-prescient
- prescient integration with company
- https://github.com/raxod502/prescient.el
#+begin_src emacs-lisp
  (use-package company-prescient
    :straight t
    :after (company prescient)
    :config
    (company-prescient-mode))
#+end_src

** Python
*** elpy code folding compatibility
#+begin_src emacs-lisp
  (add-hook 'python-mode-hook 'hs-minor-mode)
#+end_src

*** elpy
- python development environment
- uses flycheck for syntax checking backend
- external dependencies can be installed with elpy-config
- https://elpy.readthedocs.io/en/latest
#+begin_src emacs-lisp
  (use-package elpy
    :straight t
    :defer t
    :init
    (advice-add 'python-mode :before 'elpy-enable) ;; defer loading
    :config
    (when (load "flycheck" t t)
      (setq elpy-modules (delq 'elpy-module-flymake elpy-modules))
      (add-hook 'elpy-mode-hook 'flycheck-mode))
    :custom
    (elpy-folding-fringe-indicators t "enable code folding fringe indicators")
    (elpy-modules
     '(elpy-module-company
       elpy-module-eldoc
       elpy-module-flymake
       elpy-module-folding
       elpy-module-pyvenv
       elpy-module-highlight-indentation
       elpy-module-yasnippet
       elpy-module-django
       elpy-module-sane-defaults) "activate elpy modules")
    :custom-face
    (elpy-folding-fringe-face ((t (:inherit (quote font-lock-keyword-face) :box (:line-width 1 :style released-button))))))
#+end_src

** LaTeX
*** AUCTeX
- support for TeX and TeX macro packages
#+begin_src emacs-lisp
  (use-package tex ;;workaround because auctex is old
    :straight auctex
    :custom
    (TeX-auto-save t)
    (TeX-parse-self t))
#+end_src

** C++
*** rtags
- code tagging, source code navigation
- http://www.rtags.net
- needs to have active rtag server running
- projects need to be indexed
- starts rtags process on c/c++/objc modes
- C-c r ? for help
#+begin_src emacs-lisp
  (use-package rtags
    :straight t
    :config
    (rtags-enable-standard-keybindings)
    (add-hook 'c-mode-hook 'rtags-start-process-unless-running)
    (add-hook 'c++-mode-hook 'rtags-start-process-unless-running)
    (add-hook 'objc-mode-hook 'rtags-start-process-unless-running)
    (define-key c-mode-base-map (kbd "C-c r i") (function rtags-print-symbol-info))
    (define-key c-mode-base-map (kbd "C-c r t") (function rtags-symbol-type))
    :custom
    (rtags-find-file-case-insensitive t))
#+end_src

*** company-rtags
- integrate rtags with company
#+begin_src emacs-lisp
  (use-package company-rtags
    :straight t
    :after (company rtags)
    :config
    (push 'company-rtags company-backends)
    (define-key c-mode-base-map (kbd "<C-tab>") (function company-complete))
    :custom
    (rtags-completions-enabled t))
#+end_src

*** flycheck-rtags
- syntax checker using flycheck and rtags
#+begin_src emacs-lisp
  (use-package flycheck-rtags
    :straight t
    :after (flycheck rtags)
    :config
    (defun my-flycheck-rtags-setup ()
      (flycheck-select-checker 'rtags)
      (setq-local flycheck-highlighting-mode nil) ;; RTags creates more accurate overlays.
      (setq-local flycheck-check-syntax-automatically nil))
    (add-hook 'c-mode-hook #'my-flycheck-rtags-setup)
    (add-hook 'c++-mode-hook #'my-flycheck-rtags-setup)
    (add-hook 'objc-mode-hook #'my-flycheck-rtags-setup)
    :custom
    (rtags-autostart-diagnostics t))
#+end_src

*** ivy-rtags
- integrate rtags with ivy
#+begin_src emacs-lisp
  (use-package ivy-rtags
    :straight t
    :after (ivy rtags)
    :custom
    (rtags-display-result-backend 'ivy))
#+end_src

* Org Mode
** defaults
- indent org files 
#+begin_src emacs-lisp
  (setq org-startup-indented t)
#+end_src
- keep everything collapsed when first visiting an org file
#+begin_src emacs-lisp
  (setq org-startup-folded nil)
#+end_src

** GTD
- task keeping setup
- task files should be synced with Dropbox
- shortcuts to open task files
- adds custom agenda view
- keybinds only apply when the file in gtd-files exist
#+begin_src emacs-lisp
  (setq gtd-files '("~/Dropbox/gtd/inbox.org"
                    "~/Dropbox/gtd/projects.org"
                    "~/Dropbox/gtd/reminders.org"
                    "~/Dropbox/gtd/someday.org"
                    "~/Dropbox/gtd/calendar.org"))

  (defun check-exists (list)
    "t if all files in 'list' exist"
    (eval `(and ,@(mapcar
                   (lambda (filename) (file-exists-p filename))
                   list))))


  (when (check-exists gtd-files)
    (defun open-gtd-projects ()
      (interactive)
      (find-file "~/Dropbox/gtd/projects.org"))
    (defun open-gtd-inbox ()
      (interactive)
      (find-file "~/Dropbox/gtd/inbox.org"))
    (defun open-gtd-reminders ()
      (interactive)
      (find-file "~/Dropbox/gtd/reminders.org"))

    (global-set-key (kbd "C-c g a") 'org-agenda)
    (global-set-key (kbd "C-c g c") 'org-capture)
    (global-set-key (kbd "C-c g p") 'open-gtd-projects)
    (global-set-key (kbd "C-c g i") 'open-gtd-inbox)
    (global-set-key (kbd "C-c g r") 'open-gtd-reminders)

    (setq org-agenda-files '("~/Dropbox/gtd/inbox.org"
                             "~/Dropbox/gtd/projects.org"
                             "~/Dropbox/gtd/reminders.org"
                             "~/Dropbox/gtd/calendar.org"))
    (setq org-capture-templates '(("t" "Todo [inbox]" entry
                                   (file+headline "~/Dropbox/gtd/inbox.org" "Tasks")
                                   "* TODO %i%?")
                                  ("r" "Reminder" entry
                                   (file+headline "~/Dropbox/gtd/reminders.org" "Reminders")
                                   "* %i%? \n %U")))
    (setq org-refile-targets '(("~/Dropbox/gtd/projects.org" :maxlevel . 3)
                               ("~/Dropbox/gtd/someday.org" :level . 1)
                               ("~/Dropbox/gtd/reminders.org" :maxlevel . 2)))
    (setq org-todo-keywords '((sequence "TODO(t)" "NEXT(n)" "WAITING(w)" "|"
                                        "DONE(d)" "CANCELLED(c)" "DEFERRED(D)")))
    (setq org-agenda-custom-commands
          '(("1" "My Agenda"
             ((agenda ""
                      ((org-agenda-span 'day)
                       (org-deadline-warning-days 365)))
              (todo "TODO"
                    ((org-agenda-overriding-header "To Refile:")
                     (org-agenda-files '("~/Dropbox/gtd/inbox.org"))))
              (todo "NEXT"
                    ((org-agenda-overriding-header "In Progress:")
                     (org-agenda-files '("~/Dropbox/gtd/projects.org"))))
              (todo "WAITING"
                    ((org-agenda-overriding-header "Waiting:")
                     (org-agenda-files '("~/Dropbox/gtd/projects.org")))))
             nil))))
#+end_src

